/ https://github.com/clausecker
	/ (C) 2019 ROBERT CLAUSECKER
	/ B RUNTIME

	*0
	0		/ INTERRUPT HANDLER
	HLT

	*20		/ RUNTIME FUNCTIONS
ENTER=	JMS I .
	XENTER

LEAVE=	JMS I .
	XLEAVE

MULX=	JMS I .
	XMUL

MOD=	JMS I .
	XMOD

TMP1,	0		/ RUNTIME SCRATCH REGISTERS
TMP2,	0
TMP3,	0

BREG=	30		/ B RUNTIME REGISTERS

	*200		/ ENTRY POINT
ENTRY,	KCC		/ CLEAR STRAY INPUT
	TPC		/ SET TRANSMITTED FLAG
	JMS I XMAIN
	DCA TMP1	/ EXIT STATUS
	JMS EXIT
	TMP1
XMAIN,	MAIN

			/ RUNTIME SUPPORT

XBREG,	BREG-1
CR,	15
NEGCR,	-15
NL,	12
NEGNL,	-12
GETMSK,	177

XENTER,	0		/ FUNCTION PROLOGUE
	STA		/ LOAD -1
	TAD I XENTER	/ POINTER TO BEFORE FRAME AREA
	DCA 0010	/ DEPOSIT TO INDEX REGISTER
	TAD I 0010	/ NEG. NUMBER OF REGISTERS TO SAVE
	SNA		/ IF NOTHING TO SAVE
	 JMP SAVEND	/ SKIP SAVING
	DCA TMP1	/ REMEMBER AS LOOP COUNTER
	TAD XBREG	/ BEFORE FIRST B REGISTER
	DCA 0011	/ DEPOSIT TO INDEX REGISTER
SAVBEG,	TAD I 0011	/ LOAD REGISTER
	DCA I 0010	/ SAVE REGISTER
	ISZ TMP1	/ DONE SAVING?
	 JMP SAVBEG	/ CONTINUE
SAVEND,	TAD I 0010	/ NEG. NUMBER OF ARGUMENTS
	SNA		/ IF NO ARGUMENTS
	 JMP ARGEND	/ SKIP SETTING UP PARAMETERS
	DCA TMP1	/ SET UP LOOP COUNTER
	STA CLL RAL	/ LOAD -2
	TAD XENTER	/ POINTER TO CALLER'S RETURN ADDRESS
	DCA TMP2	/ REMEMBER
	STA		/ LOAD -1
	TAD I TMP2	/ BEFORE CALLERS RETURN ADDRESS
	DCA 0011	/ DEPOSIT TO INDEX REGISTER
ARGBEG,	TAD I 0011	/ POINTER TO ARGUMENT
	DCA TMP3	/ REMEMBER
	TAD I TMP3	/ ARGUMENT
	DCA I 0010	/ DEPOSIT TO ARGUMENT AREA
	ISZ TMP1	/ DONE SETTING UP PARAMETERS?
	 JMP ARGBEG	/ CONTINUE
	CLA IAC		/ LOAD 1
	TAD 0011	/ INSTRUCTION AFTER FUNCTION ARGUMENTS
	DCA I TMP2	/ MAKE CALLER RETURN TO AFTER THEM
ARGEND,	JMS RESTOR	/ SET UP FRAME TEMPLATE
TMPEND,	ISZ XENTER	/ SKIP OVER ARGUMENT
	JMP I XENTER	/ RETURN

RESTOR,	0		/ COPY -TMP1 WORDS FROM I 0010
	TAD I 0010	/ LOAD COUNT
	SNA		/ IF NOTHING TO COPY
	 JMP I RESTOR	/  RETURN
	DCA TMP1	/ SET UP COUNTER
	TAD XBREG	/ BEFORE FIRST B REGISTER
	DCA 0011	/ SET UP DESTINATION
RESTL,	TAD I 0010	/ LOAD REGISTER
	DCA I 0011	/ RESTORE REGISTER
	ISZ TMP1	/ DONE RESTORING?
	 JMP RESTL	/  CONTINUE
	JMP I RESTOR	/ RETURN

XLEAVE,	0		/ FUNCTION EPILOGUE
	DCA TMP3	/ REMEMBER RETURN VALUE
	TAD I XLEAVE	/ POINTER TO CALLER
	DCA XLEAVE	/ REMOVE LEVEL OF INDIRECTION
	TAD I XLEAVE	/ RETURN ADDRESS
	DCA TMP2	/ REMEMBER
	ISZ XLEAVE	/ POINTER TO ENTER INSTRUCTION
	ISZ XLEAVE	/ POINTER TO POINTER TO FRAME AREA
	STA		/ LOAD -1
	TAD I XLEAVE	/ POINTER TO BEFORE FRAME ARA
	DCA 0010	/ SET UP INDEX REGISTER
	JMS RESTOR	/ RESTORE REGISTERS
	TAD TMP3	/ RETURN VALUE
	JMP I TMP2	/ RETURN FROM CALLER

			/ STANDARD LIBRARY

EXIT,	0		/ EXIT PROGRAM
	CLA
	TAD I EXIT	/ LOAD POINTER TO ARGUMENT
	DCA TMP1	/ REMEMBER IT
	TAD I TMP1	/ LOAD EXIT STATUS FOR DISPLAY
	HLT		/ HALT
	JMP ENTRY	/ RESTART WHEN REQUESTED BY OPERATOR

GETCHA,	0		/ GET CHARACTER
	KSF		/ WAIT FOR INPUT
	 JMP .-1
	KRB		/ RECEIVE CHARACTER
	AND GETMSK	/ CLEAR HIGH BIT
	DCA TMP2	/ DEPOSIT A COPY
	TAD NEGCR	/ LOAD -CR
	TAD TMP2	/ TMP == CR?
	SZA CLA		/ IF WE GOT A CR
	 JMP NOTCR
	TAD NL		/ LOAD NL
	DCA TMP2	/ TRANSLATE CR TO NL
NOTCR,	JMS PUTCHA	/ ECHO CHARACTER
	TMP2		/ OUR IMPL. OF PUTCHAR RETURNS ITS ARGUMENT
	JMP I GETCHA	/ RETURN

PUTCHA,	0		/ PUT CHARACTER
	CLA
	TAD I PUTCHA	/ LOAD POINTER TO ARGUMENT
	DCA TMP1	/ REMEMBER IT
	TAD I TMP1	/ LOAD ARGUMENT
	TAD NEGNL	/ LOAD -NL
	SZA CLA		/ WANT TO PRINT NL?
	 JMP NOTNL	/ IF YES, PRINT CR FIRST
	TSF		/ WAIT FOR TELEPRINTER READY
	 JMP .-1
	TAD CR		/ LOAD CR
	TLS		/ PRINT CR
	CLA
NOTNL,	TSF		/ WAIT FOR TELEPRINTER READY
	 JMP .-1
	TAD I TMP1	/ LOAD CHARACTER TO PRINT
	TLS		/ PRINT CHARACTER
	ISZ PUTCHA	/ SKIP OVER ARGUMENT
	JMP I PUTCHA	/ RETURN

SENSE,	0		/ SENSE SWITCHES
	CLA OSR
	JMP I SENSE

XMOD,	0
	HLT		/ NOT IMPLEMENTED

	PAGE		/ ARITHMETIC SUPPORT CODE

XMUL,	0		/ MULTIPLY NUMBERS (OPERATOR *)
			/ FACTORS IN AC AND 10
	DCA 11		/ DEPOSIT 1ST FACTOR
	DCA TMP1	/ CLEAR RESULT
BEGMUL,	TAD 10		/ LOAD FACTOR
	SNA		/ DONE YET?
	 JMP RETMUL
	CLL RAR		/ GET LSB
	DCA 10		/ DEPOSIT SCALED FACTOR
	SZL		/ NEED TO ADD?
	 TAD 11
	TAD TMP1	/ ADD SCALED FACTOR TO PRODUCT
	DCA TMP1	/ UPDATE PRODUCT
	TAD 11		/ LOAD FACTOR
	CLL RAL		/ SCALE FACTOR
	DCA 11		/ DEPOSIT SCALED FACTOR
	JMP BEGMUL	/ CONTINUE
RETMUL,	TAD TMP1	/ LOAD RESULT
	JMP I XMUL	/ RETURN

L0000,	0000		/ MAIN
	ENTER
	L0001
	DCA I 0030	/ I
L0011,	CLA STL
	TAD 0031
	TAD I 0030	/ I
	SNL SZA CLA
	 JMP I 0032
	TAD I 0030	/ I
	ISZ I 0030	/ I
	 NOP
	DCA L0003+000
	JMS I 0033	/ FIB
	L0003+000
	DCA L0003+000
	JMS I 0034	/ PRINT8
	L0003+000
	JMS I 0035	/ PUTCHAR
	DATA+0000
	CLA CLL
	JMP I 0036
L0012,
L0005,	LEAVE
	L0000

L0003=	0037
L0001,	7770		/ SAVE 0010 REGISTERS
	*.+0010
	0000		/ LOAD 0000 ARGUMENTS
	7771		/ LOAD 0007 TEMPLATES
	L0004+000
	7756
	L0012
	L0006
	L0007
	L0010
	L0011
L0004,	*.+0001

L0007,	0000		/ PRINT8
	ENTER
	L0013
	TAD I 0030	/ I
	CLL RTL
	RTL
	AND 0031
	TAD 0032	/ '0'
	DCA L0015+000
	JMS I 0033	/ PUTCHAR
	L0015+000
	CLA CLL
	TAD I 0030	/ I
	BSW
	AND 0034
	AND 0031	/ 7
	TAD 0032	/ '0'
	DCA L0015+000
	JMS I 0033	/ PUTCHAR
	L0015+000
	CLA CLL
	TAD I 0030	/ I
	CLL RTR
	RAR
	AND 0035
	AND 0031	/ 7
	TAD 0032	/ '0'
	DCA L0015+000
	JMS I 0033	/ PUTCHAR
	L0015+000
	CLA CLL
	TAD I 0030	/ I
	AND 0031	/ 7
	TAD 0032	/ '0'
	DCA L0015+000
	JMS I 0033	/ PUTCHAR
	L0015+000
L0017,	LEAVE
	L0007

L0015=	0036
L0013,	7771		/ SAVE 0007 REGISTERS
	*.+0007
	7777		/ LOAD 0001 ARGUMENTS
L0014,	*.+0001
	7772		/ LOAD 0006 TEMPLATES
	L0014+000
	0007
	0060
	L0010
	0077
	0777

L0006,	0000		/ FIB
	ENTER
	L0020
	DCA I 0030	/ A
	CLA CLL IAC
	DCA I 0031	/ B
L0025,	STA CLL
	TAD I 0032	/ N
	DCA I 0032	/ N
	TAD I 0032	/ N
	IAC
	DCA L0022+000
	CLL
	TAD L0022+000
	SZL SNA CLA
	 JMP I 0033
	TAD I 0030	/ A
	DCA I 0034	/ TMP
	TAD I 0031	/ B
	DCA I 0030	/ A
	TAD I 0031	/ B
	TAD I 0034	/ TMP
	DCA I 0031	/ B
	JMP I 0035
L0026,	TAD I 0030	/ A
	JMP I 0036	/ (RETURN)
L0024,	LEAVE
	L0006

L0022=	0037
L0020,	7770		/ SAVE 0010 REGISTERS
	*.+0010
	7777		/ LOAD 0001 ARGUMENTS
L0021,	*.+0001
	7771		/ LOAD 0007 TEMPLATES
	L0023+000
	L0023+001
	L0021+000
	L0026
	L0023+002
	L0025
	L0024
L0023,	*.+0003

DATA,	0012

MAIN=	L0000
L0027=	EXIT
L0030=	GETCHA
L0010=	PUTCHA
L0031=	SENSE
L0032,	$		/ END
